{{ define "concord.db" }}
db {
  url="jdbc:postgresql://{{ .Db.server }}:{{ .Db.port }}/{{ .Db.database }}"
  appPassword = "{{ .Db.password }}"
  inventoryPassword = "{{ .Db.password }}"

  changeLogParameters {
    defaultAdminToken = "{{ .Values.server.adminToken }}"
  }
}

secretStore {
  serverPassword = "{{ .Db.password | b64enc }}"
  secretStoreSalt = "{{ .Db.password | b64enc }}"
  projectSecretSalt = "{{ .Db.password | b64enc }}"
}
{{ end -}}

concord-server {

  {{- if eq .Values.database.type "internal" }}
    {{ include "concord.db" (dict "Values" .Values "Db" .Values.database.internal) | indent 2 }}
  {{- else if eq .Values.database.type "external" -}}
    {{ include "concord.db" (dict "Values" .Values "Db" .Values.database.external) | indent 2 }}
  {{- end -}}

  {{- if .Values.ldap.enabled }}
  # AD/LDAP authentication
  ldap {
    url = "{{ .Values.ldap.url }}"
    searchBase = "{{ .Values.ldap.searchBase }}"
    principalSearchFilter = "{{ .Values.ldap.principalSearchFilter }}"
    # This is used by the UI
    userSearchFilter = "{{ .Values.ldap.userSearchFilter }}"
    usernameProperty = "{{ .Values.ldap.usernameProperty }}"
    mailProperty = {{ .Values.ldap.mailProperty }}
    groupSearchFilter = "{{ .Values.ldap.groupSearchFilter }}"
    groupNameProperty = "{{ .Values.ldap.groupNameProperty }}"
    groupDisplayNameProperty = "{{ .Values.ldap.groupDisplayNameProperty }}"
    systemUsername = "{{ .Values.ldap.systemUsername }}"
    systemPassword = "{{ .Values.ldap.systemPassword }}"
  }
  {{ end }}

  {{- if .Values.github.enabled }}
  github {
    githubDomain = "{{ .Values.github.domain }}"
    secret = "{{ .Values.github.secret }}"
  }
  {{ end }}
}
